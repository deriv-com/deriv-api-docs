---
title: WebSocket
hide_title: false
draft: false
sidebar_label: WebSocket
sidebar_position: 0
tags:
  - концепция
  - Websocket
keywords:
  - торговое приложение
  - протокол websocket
  - соединения websocket
description: Узнайте о протоколе WebSocket и соединениях WebSocket, а также о том, как их интегрировать, чтобы Вы могли обеспечить обмен данными в своем торговом приложении.
---

## Что такое WebSockets?

Протокол `WebSocket`, описанный в спецификации [RFC 6455] (https://datatracker.ietf.org/doc/html/rfc6455), предоставляет способ обмена данными между браузером и сервером через постоянное соединение. Данные могут передаваться в обоих направлениях в виде "пакетов" без разрыва соединения или необходимости дополнительных HTTP-запросов.

WebSocket особенно хорош для сервисов, требующих непрерывного обмена данными, например, торговых систем реального времени и т.д.

## Простой пример

Чтобы открыть WebSocket-соединение, нам нужно создать `новый WebSocket`, используя специальный протокол `ws` или `wss` в url. Вот как Вы можете сделать это на `JavaScript`:

```js
let socket = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');
```

:::caution
Using `wss://` is always the better choice. The `wss://` protocol is not only encrypted, but also more reliable.

С другой стороны, данные `ws://` не шифруются и могут быть видны посредникам. Старые прокси-серверы могут встретить "странные" заголовки и прервать соединение.

`wss://` означает WebSocket over TLS, подобно тому, как HTTPS - это HTTP over TLS. На транспортном уровне безопасности данные шифруются отправителем и расшифровываются получателем. Это означает, что зашифрованные пакеты данных могут успешно проходить через прокси-серверы, не подвергаясь проверке.
:::

После того, как сокет создан, мы должны прослушивать события на нем. Всего проводится 4 мероприятия:

- Открыто - соединение установлено
- Сообщение - Полученные данные
- Ошибка - ошибка WebSocket
- Закрыть - Соединение закрыто

Отправка сообщения может быть выполнена с помощью socket.send(data).

Вот пример на `JavaScript`:

```js showLineNumbers
const app_id = 1089; // Замените свой app_id или оставьте 1089 для тестирования.
const socket = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${app_id}`);

socket.onopen = function (e) {
  console.log('[open] Connection established');
  console.log('Sending to server');
  const sendMessage = JSON.stringify({ ping: 1 });
  socket.send(sendMessage);
};

socket.onmessage = function (event) {
  console.log(`[message] Данные получены от сервера: ${event.data}`);
};

socket.onclose = function (event) {
  if (event.wasClean) {
    consloe.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
  } else {
    // например, процесс сервера убит или сеть не работает
    // event.code обычно 1006 в этом случае
    console.log('[close] Connection died');
  }
};

socket.onerror = function (error) {
  console.log(`[error]`);
};
```

## Зачем нужны WebSockets и когда их следует избегать?

WebSockets - это незаменимый инструмент связи между клиентом и сервером. Чтобы извлечь максимальную пользу из их потенциала, важно понимать, чем они могут быть полезны и когда их лучше не использовать. Это подробно описано в следующем разделе.

Используйте WebSockets в следующих случаях:

1. ‍ Когда Вы разрабатываете веб-приложение в режиме реального времени.
   Наиболее распространенное применение WebSocket - разработка приложений в режиме реального времени, где он помогает непрерывно отображать данные на стороне клиента. Поскольку внутренний сервер постоянно отправляет эти данные, WebSocket позволяет непрерывно передавать их по уже открытому соединению. Использование WebSockets делает такую передачу данных быстрой и эффективно использует производительность приложения.
2. Для торговых сайтов, таких как Deriv.
   Здесь WebSocket помогает в обработке данных, которые передаются клиенту от развернутого внутреннего сервера.
3. ‍ При создании приложения для чата.
   Разработчики чат-приложений обращаются к WebSockets за помощью в таких операциях, как одноразовый обмен и публикация/трансляция сообщений. Поскольку для отправки/получения сообщений используется одно и то же соединение WebSocket, общение становится простым и быстрым.

Теперь, когда мы выяснили, где следует использовать WebSockets, давайте посмотрим, где их лучше избегать. Это поможет Вам избежать ненужных хлопот, связанных с эксплуатацией.

WebSockets не стоит брать на вооружение, если требуется только получение старых данных или данных, которые должны быть обработаны только один раз. В этих случаях использование протоколов HTTP - разумный выбор.

## WebSocket против HTTP

Поскольку для связи между приложениями используются оба протокола - HTTP и WebSocket, люди часто путаются и затрудняются выбрать один из них.

Как уже говорилось ранее, WebSocket - это фреймовый и двунаправленный протокол. С другой стороны, HTTP - это однонаправленный протокол, функционирующий поверх протокола TCP.

Поскольку протокол WebSocket способен поддерживать непрерывную передачу данных, он в основном используется при разработке приложений, работающих в режиме реального времени. HTTP не имеет статистики и используется для разработки [RESTful](https://de.wikipedia.org/wiki/Representational_State_Transfer) и [SOAP](https://de.wikipedia.org/wiki/SOAP) приложений. SOAP все еще может использовать HTTP для реализации, но REST широко распространен и используется.

В WebSocket связь происходит на обоих концах, что делает этот протокол более быстрым. В HTTP соединение создается на одном конце, что делает его немного более медлительным, чем WebSocket.

WebSocket использует единое TCP-соединение и нуждается в одной стороне для разрыва соединения. Пока этого не произойдет, соединение остается активным. HTTP необходимо создать отдельное соединение для отдельных запросов. Как только запрос будет выполнен, соединение автоматически разорвется.

## Как устанавливаются соединения WebSocket?

Процесс начинается с рукопожатия WebSocket, которое предполагает использование новой схемы (ws или wss). Чтобы помочь Вам понять, считайте, что они эквивалентны HTTP и защищенному HTTP (HTTPS) соответственно.

При использовании этой схемы серверы и клиенты должны следовать стандартному протоколу соединения WebSocket. Установление соединения WebSocket начинается с обновления HTTP-запроса, который содержит несколько заголовков, таких как Connection: Upgrade, Upgrade: WebSocket, Sec-WebSocket- Key и так далее.

Вот как устанавливается эта связь:

1. **Запрос :** Заголовок Connection Upgrade обозначает рукопожатие WebSocket, а Sec-WebSocket-Key содержит Base64-кодированное случайное значение. Это значение произвольно генерируется во время каждого рукопожатия WebSocket. Помимо вышеперечисленного, заголовок ключа также является частью этого запроса.

Перечисленные выше заголовки, объединяясь, формируют HTTP GET запрос. В нем будут содержаться аналогичные данные:

```
GET ws://websocketexample.com:8181/ HTTP/1.1
Хост: localhost:8181
Соединение: Обновление
Pragma: no-cache
Cache-Control: no-cache
Обновление: websocket
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: b6gjhT32u488lpuRwKaOWs==.
```

Чтобы пояснить Sec-WebSocket-Version, можно объяснить версию протокола WebSocket, готовую к использованию клиентом.

2. **Ответ:** Заголовок ответа, Sec-WebSocket-Accept, содержит остальные значения, переданные в заголовке запроса Sec-WebSocket-Key. Это связано с конкретной спецификацией протокола и широко используется для предотвращения недостоверной информации. Другими словами, он повышает безопасность API и не дает плохо настроенным серверам создавать ошибки при разработке приложений.

При успешном выполнении ранее отправленного запроса будет получен ответ, аналогичный приведенной ниже текстовой последовательности:

```
HTTP/1.1 101 Переключение протоколов
Обновление: websocket
Соединение: Обновление
Sec-WebSocket-Accept: rG8wsswmHTJ85lJgAE3M5RTmcCE=.
```

## Ссылки

- \*\* [WebSockets APIs - MDN](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)\*\*.
- \*\* [WebSocket - Javascript Info](https://javascript.info/websocket)\*\*.
